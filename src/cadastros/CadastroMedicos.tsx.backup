/**
 * Módulo 01: Cadastro de Médicos
 * Sistema completo de cadastro com validações, IA e integrações
 * 
 * Documentação: MODULOS_CADASTROS_COMPRAS_COMPLETO.md (Seção 5)
 * OraclusX DS: 100% compliance
 * Hard Gates: Ativado
 */

import { useState, useRef } from "react";
import { z } from "zod";
import { useNavigate } from "react-router-dom";
import { Paperclip, AlertTriangle, Check, Loader2, Trash2, Stethoscope, User, Phone, MapPin, CreditCard, FileText } from 'lucide-react';
import { toast } from "sonner";

// Services
import { cadastrosService } from "@/services/CadastrosService";
import { validacaoService } from "@/services/ValidacaoService";
import { duplicateDetectionService } from "@/services/DuplicateDetectionService";

// Types
import type { MedicoFormData, ValidationErrors } from "@/types/cadastros";

// Hooks
import { useDocumentTitle } from "@/hooks";

// Components
import {
  CadastroPageLayout,
  CadastroSection,
  FormGrid,
  FormActions,
  Button,
  Alert,
} from "@/components/oraclusx-ds";
import { FormFieldError } from "@/components/oraclusx-ds/FormFieldError";

interface PossivelDuplicata {
  nome?: string;
  motivo?: string;
}

// Estados brasileiros
const ESTADOS_BRASILEIROS = [
  { value: 'AC', label: 'Acre' },
  { value: 'AL', label: 'Alagoas' },
  { value: 'AP', label: 'Amapá' },
  { value: 'AM', label: 'Amazonas' },
  { value: 'BA', label: 'Bahia' },
  { value: 'CE', label: 'Ceará' },
  { value: 'DF', label: 'Distrito Federal' },
  { value: 'ES', label: 'Espírito Santo' },
  { value: 'GO', label: 'Goiás' },
  { value: 'MA', label: 'Maranhão' },
  { value: 'MT', label: 'Mato Grosso' },
  { value: 'MS', label: 'Mato Grosso do Sul' },
  { value: 'MG', label: 'Minas Gerais' },
  { value: 'PA', label: 'Pará' },
  { value: 'PB', label: 'Paraíba' },
  { value: 'PR', label: 'Paraná' },
  { value: 'PE', label: 'Pernambuco' },
  { value: 'PI', label: 'Piauí' },
  { value: 'RJ', label: 'Rio de Janeiro' },
  { value: 'RN', label: 'Rio Grande do Norte' },
  { value: 'RS', label: 'Rio Grande do Sul' },
  { value: 'RO', label: 'Rondônia' },
  { value: 'RR', label: 'Roraima' },
  { value: 'SC', label: 'Santa Catarina' },
  { value: 'SP', label: 'São Paulo' },
  { value: 'SE', label: 'Sergipe' },
  { value: 'TO', label: 'Tocantins' }
];

// Especialidades médicas
const ESPECIALIDADES = [
  { value: 'cardiologia', label: 'Cardiologia' },
  { value: 'ortopedia', label: 'Ortopedia' },
  { value: 'neurologia', label: 'Neurologia' },
  { value: 'pediatria', label: 'Pediatria' },
  { value: 'ginecologia', label: 'Ginecologia e Obstetrícia' },
  { value: 'cirurgia_geral', label: 'Cirurgia Geral' },
  { value: 'anestesiologia', label: 'Anestesiologia' },
  { value: 'radiologia', label: 'Radiologia' },
  { value: 'dermatologia', label: 'Dermatologia' },
  { value: 'oftalmologia', label: 'Oftalmologia' }
];

// Estado inicial
const INITIAL_STATE: MedicoFormData = {
  nome_completo: '',
  cpf: '',
  rg: '',
  data_nascimento: '',
  sexo: '',
  crm: '',
  uf_crm: '',
  especialidade: '',
  registro_ans: '',
  telefone: '',
  celular: '',
  email: '',
  linkedin: '',
  endereco: {
    cep: '',
    logradouro: '',
    numero: '',
    complemento: '',
    bairro: '',
    cidade: '',
    uf: ''
  },
  dados_bancarios: {
    banco: '',
    agencia: '',
    conta: '',
    tipo_conta: 'corrente',
    pix: ''
  },
  observacoes: '',
  ativo: true
};

export default function CadastroMedicos() {
  useDocumentTitle("Cadastro de Médicos");
  const navigate = useNavigate();

  // Estados
  const [formData, setFormData] = useState<MedicoFormData>(INITIAL_STATE);
  const [validationErrors, setValidationErrors] = useState<ValidationErrors>({});
  const [loading, setLoading] = useState(false);
  const [validatingCRM, setValidatingCRM] = useState(false);
  const [buscandoCEP, setBuscandoCEP] = useState(false);
  const [possiveisDuplicatas, setPossiveisDuplicatas] = useState<PossivelDuplicata[]>([]);
  const [documentosUpload, setDocumentosUpload] = useState<File[]>([]);
  const [documentosErro, setDocumentosErro] = useState<string | null>(null);
  const documentosInputRef = useRef<HTMLInputElement | null>(null);

  // Zod schema para validação padronizada
  const medicoSchema = z.object({
    nome_completo: z.string().min(2, "Nome completo é obrigatório"),
    crm: z.string().min(1, "CRM é obrigatório"),
    uf_crm: z.string().min(1, "UF do CRM é obrigatória"),
    email: z.string().email("Email inválido").optional().or(z.literal("")),
  });

  // Validação de CRM
  const handleCRMChange = async (crm: string, uf: string) => {
    setFormData({ ...formData, crm, uf_crm: uf });

    const { crm: _, ...restErrors } = validationErrors;
    setValidationErrors(restErrors);

    if (crm && uf) {
      setValidatingCRM(true);
      try {
        const resultado = await validacaoService.consultarCRM(crm, uf);

        if (!resultado.ativo) {
          setValidationErrors({
            ...validationErrors,
            crm: resultado.mensagem || 'CRM inválido'
          });
        } else {
          setFormData(prev => ({
            ...prev,
            nome_completo: resultado.nome || prev.nome_completo,
            especialidade: resultado.especialidade || prev.especialidade,
          }));

          // Verificar duplicação
          const duplicatas = await duplicateDetectionService.detectPossibleDuplicates({
            tipo: 'medico',
            crm,
            uf_crm: uf
          });

          if (duplicatas.length > 0) {
            setPossiveisDuplicatas(duplicatas);
          }
        }
      } catch (error) {
        console.warn('Erro ao consultar CRM:', error);
      } finally {
        setValidatingCRM(false);
      }
    }
  };

  // Busca de CEP
  const handleCEPChange = async (cep: string) => {
    const cepLimpo = cep.replace(/\D/g, '');
    
    setFormData(prev => ({
      ...prev,
      endereco: { ...prev.endereco, cep }
    }));

    if (cepLimpo.length === 8) {
      setBuscandoCEP(true);
      try {
        const resultado = await validacaoService.buscarCEP(cepLimpo);
        
        if (resultado) {
          setFormData(prev => ({
            ...prev,
            endereco: {
              ...prev.endereco,
              cep,
              logradouro: resultado.logradouro || '',
              bairro: resultado.bairro || '',
              cidade: resultado.localidade || '',
              uf: resultado.uf || ''
            }
          }));
        }
      } catch (error) {
        console.warn('Erro ao buscar CEP:', error);
        toast.error('CEP não encontrado');
      } finally {
        setBuscandoCEP(false);
      }
    }
  };

  // Handle input change
  const handleChange = (
    e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement | HTMLSelectElement>
  ) => {
    const { id, value } = e.target;

    // Nested address fields
    if (
      id.startsWith("cep") ||
      id.startsWith("logradouro") ||
      id.startsWith("numero") ||
      id.startsWith("complemento") ||
      id.startsWith("bairro") ||
      id.startsWith("cidade") ||
      id.startsWith("uf")
    ) {
      const addressKey = id.split("_")[0] as keyof typeof formData.endereco;
      setFormData((prev) => ({
        ...prev,
        endereco: {
          ...prev.endereco,
          [addressKey]: value,
        },
      }));
      return;
    }

    // Nested banking fields
    if (
      id.startsWith("banco") ||
      id.startsWith("agencia") ||
      id.startsWith("conta") ||
      id.startsWith("tipo_conta") ||
      id.startsWith("pix")
    ) {
      const bankKey = id.replace("dados_bancarios_", "") as keyof typeof formData.dados_bancarios;
      setFormData((prev) => ({
        ...prev,
        dados_bancarios: {
          ...prev.dados_bancarios,
          [bankKey]: value,
        },
      }));
      return;
    }

    // Regular fields
    setFormData((prev) => ({ ...prev, [id]: value }));
    
    // Clear error
    if (validationErrors[id]) {
      const newErrors = { ...validationErrors };
      delete newErrors[id];
      setValidationErrors(newErrors);
    }
  };

  // Upload de documentos
  const handleFileUpload = (e: React.ChangeEvent<HTMLInputElement>) => {
    const files = e.target.files;
    if (!files || files.length === 0) return;

    const fileList = Array.from(files);
    const maxSize = 10 * 1024 * 1024; // 10MB
    const allowedTypes = ['application/pdf', 'image/jpeg', 'image/png'];

    const validFiles = fileList.filter(file => {
      if (file.size > maxSize) {
        setDocumentosErro(`${file.name} excede 10MB`);
        return false;
      }
      if (!allowedTypes.includes(file.type)) {
        setDocumentosErro(`${file.name} não é PDF/JPG/PNG`);
        return false;
      }
      return true;
    });

    setDocumentosUpload([...documentosUpload, ...validFiles]);
    setDocumentosErro(null);
  };

  const removeFile = (index: number) => {
    setDocumentosUpload(documentosUpload.filter((_, i) => i !== index));
  };

  // Submit
  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();

    const parsed = medicoSchema.safeParse(formData);
    if (!parsed.success) {
      const errs: ValidationErrors = {};
      for (const issue of parsed.error.issues) {
        const key = (issue.path[0] as string) ?? 'form';
        errs[key] = issue.message;
      }
      setValidationErrors(errs);
      toast.error("Preencha todos os campos obrigatórios");
      return;
    }

    setLoading(true);
    try {
      await cadastrosService.criarMedico(parsed.data);
      toast.success("Médico cadastrado com sucesso!");
      navigate("/cadastros/medicos");
    } catch (error) {
      console.error("Erro ao cadastrar médico:", error);
      toast.error("Erro ao cadastrar médico");
    } finally {
      setLoading(false);
    }
  };

  return (
    <CadastroPageLayout
      title="Novo Médico"
      description="Cadastre um novo médico no sistema"
      icon={Stethoscope}
      breadcrumbs={[
        { label: "Cadastros", href: "/cadastros" },
        { label: "Médicos", href: "/cadastros/medicos" },
        { label: "Novo" },
      ]}
      actions={
        <Button variant="ghost" onClick={() => navigate(-1)}>
          Voltar
        </Button>
      }
    >
      <form onSubmit={handleSubmit} className="space-y-6">
        {/* Possíveis Duplicatas */}
        {possiveisDuplicatas.length > 0 && (
          <Alert variant="warning" icon={<AlertTriangle />}>
            <strong>Atenção:</strong> Possível duplicata encontrada - {possiveisDuplicatas[0].nome}
          </Alert>
        )}

        {/* Dados Pessoais */}
        <CadastroSection
          title="Dados Pessoais"
          description="Informações básicas do médico"
          icon={User}
        >
          <FormGrid columns={2}>
            <div className="col-span-2">
              <label htmlFor="nome_completo" className="block text-sm font-medium text-[var(--orx-text-primary)] mb-1">
                Nome Completo <span className="text-[var(--orx-error)]">*</span>
              </label>
              <input
                type="text"
                id="nome_completo"
                value={formData.nome_completo}
                onChange={handleChange}
                className="w-full px-3 py-2 border border-[var(--orx-border-muted)] rounded-md focus:ring-2 focus:ring-[var(--orx-primary)] focus:border-transparent bg-[var(--orx-bg-light)] text-[var(--orx-text-primary)] orx-transition-all"
                placeholder="Nome completo do médico"
              />
              {validationErrors.nome_completo && <FormFieldError message={validationErrors.nome_completo} />}
            </div>

            <div>
              <label htmlFor="cpf" className="block text-sm font-medium text-[var(--orx-text-primary)] mb-1">
                CPF
              </label>
              <input
                type="text"
                id="cpf"
                value={formData.cpf}
                onChange={handleChange}
                className="w-full px-3 py-2 border border-[var(--orx-border-muted)] rounded-md focus:ring-2 focus:ring-[var(--orx-primary)] focus:border-transparent bg-[var(--orx-bg-light)] text-[var(--orx-text-primary)] orx-transition-all"
                placeholder="000.000.000-00"
              />
            </div>

            <div>
              <label htmlFor="rg" className="block text-sm font-medium text-[var(--orx-text-primary)] mb-1">
                RG
              </label>
              <input
                type="text"
                id="rg"
                value={formData.rg}
                onChange={handleChange}
                className="w-full px-3 py-2 border border-[var(--orx-border-muted)] rounded-md focus:ring-2 focus:ring-[var(--orx-primary)] focus:border-transparent bg-[var(--orx-bg-light)] text-[var(--orx-text-primary)] orx-transition-all"
                placeholder="00.000.000-0"
              />
            </div>

            <div>
              <label htmlFor="data_nascimento" className="block text-sm font-medium text-[var(--orx-text-primary)] mb-1">
                Data de Nascimento
              </label>
              <input
                type="date"
                id="data_nascimento"
                value={formData.data_nascimento}
                onChange={handleChange}
                className="w-full px-3 py-2 border border-[var(--orx-border-muted)] rounded-md focus:ring-2 focus:ring-[var(--orx-primary)] focus:border-transparent bg-[var(--orx-bg-light)] text-[var(--orx-text-primary)] orx-transition-all"
              />
            </div>

            <div>
              <label htmlFor="sexo" className="block text-sm font-medium text-[var(--orx-text-primary)] mb-1">
                Sexo
              </label>
              <select
                id="sexo"
                value={formData.sexo}
                onChange={handleChange}
                className="w-full px-3 py-2 border border-[var(--orx-border-muted)] rounded-md focus:ring-2 focus:ring-[var(--orx-primary)] focus:border-transparent bg-[var(--orx-bg-light)] text-[var(--orx-text-primary)] orx-transition-all"
              >
                <option value="">Selecione...</option>
                <option value="M">Masculino</option>
                <option value="F">Feminino</option>
              </select>
            </div>
          </FormGrid>
        </CadastroSection>

        {/* Registro Profissional */}
        <CadastroSection
          title="Registro Profissional"
          description="CRM e especialidade médica"
          icon={Stethoscope}
        >
          <FormGrid columns={3}>
            <div>
              <label htmlFor="crm" className="block text-sm font-medium text-[var(--orx-text-primary)] mb-1">
                CRM <span className="text-[var(--orx-error)]">*</span>
              </label>
              <div className="relative">
                <input
                  type="text"
                  id="crm"
                  value={formData.crm}
                  onChange={(e) => handleCRMChange(e.target.value, formData.uf_crm)}
                  className="w-full px-3 py-2 border border-[var(--orx-border-muted)] rounded-md focus:ring-2 focus:ring-[var(--orx-primary)] focus:border-transparent bg-[var(--orx-bg-light)] text-[var(--orx-text-primary)] orx-transition-all"
                  placeholder="000000"
                />
                {validatingCRM && (
                  <Loader2 className="absolute right-3 top-1/2 -translate-y-1/2 h-4 w-4 orx-spin text-[var(--orx-primary)]" />
                )}
                {!validatingCRM && formData.crm && !validationErrors.crm && (
                  <Check className="absolute right-3 top-1/2 -translate-y-1/2 h-4 w-4 text-[var(--orx-success)]" />
                )}
              </div>
              {validationErrors.crm && <FormFieldError message={validationErrors.crm} />}
            </div>

            <div>
              <label htmlFor="uf_crm" className="block text-sm font-medium text-[var(--orx-text-primary)] mb-1">
                UF do CRM <span className="text-[var(--orx-error)]">*</span>
              </label>
              <select
                id="uf_crm"
                value={formData.uf_crm}
                onChange={(e) => handleCRMChange(formData.crm, e.target.value)}
                className="w-full px-3 py-2 border border-[var(--orx-border-muted)] rounded-md focus:ring-2 focus:ring-[var(--orx-primary)] focus:border-transparent bg-[var(--orx-bg-light)] text-[var(--orx-text-primary)] orx-transition-all"
              >
                <option value="">Selecione...</option>
                {ESTADOS_BRASILEIROS.map(estado => (
                  <option key={estado.value} value={estado.value}>{estado.label}</option>
                ))}
              </select>
              {validationErrors.uf_crm && <FormFieldError message={validationErrors.uf_crm} />}
            </div>

            <div>
              <label htmlFor="especialidade" className="block text-sm font-medium text-[var(--orx-text-primary)] mb-1">
                Especialidade
              </label>
              <select
                id="especialidade"
                value={formData.especialidade}
                onChange={handleChange}
                className="w-full px-3 py-2 border border-[var(--orx-border-muted)] rounded-md focus:ring-2 focus:ring-[var(--orx-primary)] focus:border-transparent bg-[var(--orx-bg-light)] text-[var(--orx-text-primary)] orx-transition-all"
              >
                <option value="">Selecione...</option>
                {ESPECIALIDADES.map(esp => (
                  <option key={esp.value} value={esp.value}>{esp.label}</option>
                ))}
              </select>
            </div>

            <div className="col-span-3">
              <label htmlFor="registro_ans" className="block text-sm font-medium text-[var(--orx-text-primary)] mb-1">
                Registro ANS
              </label>
              <input
                type="text"
                id="registro_ans"
                value={formData.registro_ans}
                onChange={handleChange}
                className="w-full px-3 py-2 border border-[var(--orx-border-muted)] rounded-md focus:ring-2 focus:ring-[var(--orx-primary)] focus:border-transparent bg-[var(--orx-bg-light)] text-[var(--orx-text-primary)] orx-transition-all"
                placeholder="Número do registro ANS"
              />
            </div>
          </FormGrid>
        </CadastroSection>

        {/* Contato */}
        <CadastroSection
          title="Contato"
          description="Telefones e meios de comunicação"
          icon={Phone}
        >
          <FormGrid columns={2}>
            <div>
              <label htmlFor="telefone" className="block text-sm font-medium text-[var(--orx-text-primary)] mb-1">
                Telefone
              </label>
              <input
                type="tel"
                id="telefone"
                value={formData.telefone}
                onChange={handleChange}
                className="w-full px-3 py-2 border border-[var(--orx-border-muted)] rounded-md focus:ring-2 focus:ring-[var(--orx-primary)] focus:border-transparent bg-[var(--orx-bg-light)] text-[var(--orx-text-primary)] orx-transition-all"
                placeholder="(00) 0000-0000"
              />
            </div>

            <div>
              <label htmlFor="celular" className="block text-sm font-medium text-[var(--orx-text-primary)] mb-1">
                Celular
              </label>
              <input
                type="tel"
                id="celular"
                value={formData.celular}
                onChange={handleChange}
                className="w-full px-3 py-2 border border-[var(--orx-border-muted)] rounded-md focus:ring-2 focus:ring-[var(--orx-primary)] focus:border-transparent bg-[var(--orx-bg-light)] text-[var(--orx-text-primary)] orx-transition-all"
                placeholder="(00) 00000-0000"
              />
            </div>

            <div>
              <label htmlFor="email" className="block text-sm font-medium text-[var(--orx-text-primary)] mb-1">
                Email
              </label>
              <input
                type="email"
                id="email"
                value={formData.email}
                onChange={handleChange}
                className="w-full px-3 py-2 border border-[var(--orx-border-muted)] rounded-md focus:ring-2 focus:ring-[var(--orx-primary)] focus:border-transparent bg-[var(--orx-bg-light)] text-[var(--orx-text-primary)] orx-transition-all"
                placeholder="medico@email.com"
              />
            </div>

            <div>
              <label htmlFor="linkedin" className="block text-sm font-medium text-[var(--orx-text-primary)] mb-1">
                LinkedIn
              </label>
              <input
                type="url"
                id="linkedin"
                value={formData.linkedin}
                onChange={handleChange}
                className="w-full px-3 py-2 border border-[var(--orx-border-muted)] rounded-md focus:ring-2 focus:ring-[var(--orx-primary)] focus:border-transparent bg-[var(--orx-bg-light)] text-[var(--orx-text-primary)] orx-transition-all"
                placeholder="https://linkedin.com/in/..."
              />
            </div>
          </FormGrid>
        </CadastroSection>

        {/* Endereço */}
        <CadastroSection
          title="Endereço"
          description="Localização do médico"
          icon={MapPin}
        >
          <FormGrid columns={4}>
            <div>
              <label htmlFor="cep" className="block text-sm font-medium text-[var(--orx-text-primary)] mb-1">
                CEP
              </label>
              <div className="relative">
                <input
                  type="text"
                  id="cep"
                  value={formData.endereco.cep}
                  onChange={(e) => handleCEPChange(e.target.value)}
                  className="w-full px-3 py-2 border border-[var(--orx-border-muted)] rounded-md focus:ring-2 focus:ring-[var(--orx-primary)] focus:border-transparent bg-[var(--orx-bg-light)] text-[var(--orx-text-primary)] orx-transition-all"
                  placeholder="00000-000"
                />
                {buscandoCEP && (
                  <Loader2 className="absolute right-3 top-1/2 -translate-y-1/2 h-4 w-4 orx-spin text-[var(--orx-primary)]" />
                )}
              </div>
            </div>

            <div className="col-span-2">
              <label htmlFor="logradouro" className="block text-sm font-medium text-[var(--orx-text-primary)] mb-1">
                Logradouro
              </label>
              <input
                type="text"
                id="logradouro"
                value={formData.endereco.logradouro}
                onChange={handleChange}
                className="w-full px-3 py-2 border border-[var(--orx-border-muted)] rounded-md focus:ring-2 focus:ring-[var(--orx-primary)] focus:border-transparent bg-[var(--orx-bg-light)] text-[var(--orx-text-primary)] orx-transition-all"
                placeholder="Rua, Avenida, etc."
              />
            </div>

            <div>
              <label htmlFor="numero" className="block text-sm font-medium text-[var(--orx-text-primary)] mb-1">
                Número
              </label>
              <input
                type="text"
                id="numero"
                value={formData.endereco.numero}
                onChange={handleChange}
                className="w-full px-3 py-2 border border-[var(--orx-border-muted)] rounded-md focus:ring-2 focus:ring-[var(--orx-primary)] focus:border-transparent bg-[var(--orx-bg-light)] text-[var(--orx-text-primary)] orx-transition-all"
                placeholder="Nº"
              />
            </div>

            <div>
              <label htmlFor="complemento" className="block text-sm font-medium text-[var(--orx-text-primary)] mb-1">
                Complemento
              </label>
              <input
                type="text"
                id="complemento"
                value={formData.endereco.complemento}
                onChange={handleChange}
                className="w-full px-3 py-2 border border-[var(--orx-border-muted)] rounded-md focus:ring-2 focus:ring-[var(--orx-primary)] focus:border-transparent bg-[var(--orx-bg-light)] text-[var(--orx-text-primary)] orx-transition-all"
                placeholder="Apto, Bloco, etc."
              />
            </div>

            <div>
              <label htmlFor="bairro" className="block text-sm font-medium text-[var(--orx-text-primary)] mb-1">
                Bairro
              </label>
              <input
                type="text"
                id="bairro"
                value={formData.endereco.bairro}
                onChange={handleChange}
                className="w-full px-3 py-2 border border-[var(--orx-border-muted)] rounded-md focus:ring-2 focus:ring-[var(--orx-primary)] focus:border-transparent bg-[var(--orx-bg-light)] text-[var(--orx-text-primary)] orx-transition-all"
                placeholder="Bairro"
              />
            </div>

            <div>
              <label htmlFor="cidade" className="block text-sm font-medium text-[var(--orx-text-primary)] mb-1">
                Cidade
              </label>
              <input
                type="text"
                id="cidade"
                value={formData.endereco.cidade}
                onChange={handleChange}
                className="w-full px-3 py-2 border border-[var(--orx-border-muted)] rounded-md focus:ring-2 focus:ring-[var(--orx-primary)] focus:border-transparent bg-[var(--orx-bg-light)] text-[var(--orx-text-primary)] orx-transition-all"
                placeholder="Cidade"
              />
            </div>

            <div>
              <label htmlFor="uf" className="block text-sm font-medium text-[var(--orx-text-primary)] mb-1">
                UF
              </label>
              <select
                id="uf"
                value={formData.endereco.uf}
                onChange={handleChange}
                className="w-full px-3 py-2 border border-[var(--orx-border-muted)] rounded-md focus:ring-2 focus:ring-[var(--orx-primary)] focus:border-transparent bg-[var(--orx-bg-light)] text-[var(--orx-text-primary)] orx-transition-all"
              >
                <option value="">Selecione...</option>
                {ESTADOS_BRASILEIROS.map(estado => (
                  <option key={estado.value} value={estado.value}>{estado.value}</option>
                ))}
              </select>
            </div>
          </FormGrid>
        </CadastroSection>

        {/* Dados Bancários */}
        <CadastroSection
          title="Dados Bancários"
          description="Para pagamentos de honorários"
          icon={CreditCard}
        >
          <FormGrid columns={3}>
            <div>
              <label htmlFor="dados_bancarios_banco" className="block text-sm font-medium text-[var(--orx-text-primary)] mb-1">
                Banco
              </label>
              <input
                type="text"
                id="dados_bancarios_banco"
                value={formData.dados_bancarios.banco}
                onChange={handleChange}
                className="w-full px-3 py-2 border border-[var(--orx-border-muted)] rounded-md focus:ring-2 focus:ring-[var(--orx-primary)] focus:border-transparent bg-[var(--orx-bg-light)] text-[var(--orx-text-primary)] orx-transition-all"
                placeholder="Ex: 001 - Banco do Brasil"
              />
            </div>

            <div>
              <label htmlFor="dados_bancarios_agencia" className="block text-sm font-medium text-[var(--orx-text-primary)] mb-1">
                Agência
              </label>
              <input
                type="text"
                id="dados_bancarios_agencia"
                value={formData.dados_bancarios.agencia}
                onChange={handleChange}
                className="w-full px-3 py-2 border border-[var(--orx-border-muted)] rounded-md focus:ring-2 focus:ring-[var(--orx-primary)] focus:border-transparent bg-[var(--orx-bg-light)] text-[var(--orx-text-primary)] orx-transition-all"
                placeholder="0000"
              />
            </div>

            <div>
              <label htmlFor="dados_bancarios_conta" className="block text-sm font-medium text-[var(--orx-text-primary)] mb-1">
                Conta
              </label>
              <input
                type="text"
                id="dados_bancarios_conta"
                value={formData.dados_bancarios.conta}
                onChange={handleChange}
                className="w-full px-3 py-2 border border-[var(--orx-border-muted)] rounded-md focus:ring-2 focus:ring-[var(--orx-primary)] focus:border-transparent bg-[var(--orx-bg-light)] text-[var(--orx-text-primary)] orx-transition-all"
                placeholder="00000-0"
              />
            </div>

            <div>
              <label htmlFor="dados_bancarios_tipo_conta" className="block text-sm font-medium text-[var(--orx-text-primary)] mb-1">
                Tipo de Conta
              </label>
              <select
                id="dados_bancarios_tipo_conta"
                value={formData.dados_bancarios.tipo_conta}
                onChange={handleChange}
                className="w-full px-3 py-2 border border-[var(--orx-border-muted)] rounded-md focus:ring-2 focus:ring-[var(--orx-primary)] focus:border-transparent bg-[var(--orx-bg-light)] text-[var(--orx-text-primary)] orx-transition-all"
              >
                <option value="corrente">Corrente</option>
                <option value="poupanca">Poupança</option>
              </select>
            </div>

            <div className="col-span-2">
              <label htmlFor="dados_bancarios_pix" className="block text-sm font-medium text-[var(--orx-text-primary)] mb-1">
                Chave PIX
              </label>
              <input
                type="text"
                id="dados_bancarios_pix"
                value={formData.dados_bancarios.pix}
                onChange={handleChange}
                className="w-full px-3 py-2 border border-[var(--orx-border-muted)] rounded-md focus:ring-2 focus:ring-[var(--orx-primary)] focus:border-transparent bg-[var(--orx-bg-light)] text-[var(--orx-text-primary)] orx-transition-all"
                placeholder="CPF, Email, Telefone ou Chave Aleatória"
              />
            </div>
          </FormGrid>
        </CadastroSection>

        {/* Documentos */}
        <CadastroSection
          title="Documentos"
          description="Upload de documentos (CRM, RG, CPF, Diplomas)"
          icon={Paperclip}
        >
          <div className="space-y-4">
            <div>
              <input
                ref={documentosInputRef}
                type="file"
                multiple
                accept=".pdf,.jpg,.jpeg,.png"
                onChange={handleFileUpload}
                className="hidden"
              />
              <Button
                type="button"
                variant="secondary"
                onClick={() => documentosInputRef.current?.click()}
                icon={<Paperclip />}
              >
                Adicionar Documentos
              </Button>
              <p className="text-xs text-[var(--orx-text-secondary)] mt-1">
                PDF, JPG ou PNG - Máximo 10MB por arquivo
              </p>
              {documentosErro && <FormFieldError message={documentosErro} />}
            </div>

            {documentosUpload.length > 0 && (
              <div className="space-y-2">
                {documentosUpload.map((file, index) => (
                  <div
                    key={index}
                    className="flex items-center justify-between p-3 bg-[var(--orx-bg-muted)] rounded-md"
                  >
                    <div className="flex items-center gap-2">
                      <Paperclip className="h-4 w-4 text-[var(--orx-text-secondary)]" />
                      <span className="text-sm text-[var(--orx-text-primary)]">{file.name}</span>
                      <span className="text-xs text-[var(--orx-text-secondary)]">
                        ({(file.size / 1024 / 1024).toFixed(2)} MB)
                      </span>
                    </div>
                    <button
                      type="button"
                      onClick={() => removeFile(index)}
                      className="p-1 hover:bg-[var(--orx-error)]/10 rounded"
                    >
                      <Trash2 className="h-4 w-4 text-[var(--orx-error)]" />
                    </button>
                  </div>
                ))}
              </div>
            )}
          </div>
        </CadastroSection>

        {/* Observações */}
        <CadastroSection
          title="Observações"
          description="Informações adicionais"
          icon={FileText}
        >
          <div>
            <label htmlFor="observacoes" className="block text-sm font-medium text-[var(--orx-text-primary)] mb-1">
              Observações
            </label>
            <textarea
              id="observacoes"
              value={formData.observacoes}
              onChange={handleChange}
              rows={4}
              className="w-full px-3 py-2 border border-[var(--orx-border-muted)] rounded-md focus:ring-2 focus:ring-[var(--orx-primary)] focus:border-transparent bg-[var(--orx-bg-light)] text-[var(--orx-text-primary)] orx-transition-all"
              placeholder="Informações adicionais relevantes"
            />
          </div>
        </CadastroSection>

        {/* Actions */}
        <FormActions align="between">
          <Button type="button" variant="ghost" onClick={() => navigate(-1)}>
            Cancelar
          </Button>
          <Button 
            type="submit" 
            variant="primary" 
            disabled={loading}
            icon={loading ? <Loader2 className="orx-spin" /> : <Check />}
          >
            {loading ? "Salvando..." : "Salvar Médico"}
          </Button>
        </FormActions>
      </form>
    </CadastroPageLayout>
  );
}
