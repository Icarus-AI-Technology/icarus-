name: Quality Gates CI

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]

jobs:
  quality-check:
    name: Quality Score Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run ESLint
        run: pnpm lint
        continue-on-error: false

      - name: Run TypeScript Check
        run: pnpm type-check
        continue-on-error: false

      - name: Run Tests
        run: pnpm test:coverage
        continue-on-error: false

      - name: Check 'any' types
        run: |
          ANY_COUNT=$(grep -r ": any" src/ --include="*.ts" --include="*.tsx" | grep -v "node_modules" | grep -v ".test.ts" | wc -l || echo "0")
          echo "Found $ANY_COUNT 'any' types"
          if [ "$ANY_COUNT" -gt 50 ]; then
            echo "‚ùå Too many 'any' types: $ANY_COUNT (max: 50)"
            exit 1
          fi

      - name: Run Quality Monitor
        run: ./scripts/quality/monitor-quality.sh
        continue-on-error: false

      - name: Upload coverage reports
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage/lcov.info
          flags: unittests
          name: codecov-umbrella

      - name: Comment PR with results
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}
          script: |
            const fs = require('fs');
            const metrics = fs.readFileSync('logs/quality-metrics.log', 'utf8').split('\n').pop();

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## üìä Quality Check Results\n\n‚úÖ All quality gates passed!\n\n**Metrics:** \`${metrics}\``
            });

  build-check:
    name: Build Check
    runs-on: ubuntu-latest
    needs: quality-check

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build
        run: pnpm build

      - name: Check build size
        run: |
          BUILD_SIZE=$(du -sh dist/ | cut -f1)
          echo "Build size: $BUILD_SIZE"
          echo "‚úÖ Build completed successfully!"
