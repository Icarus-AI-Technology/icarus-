name: ğŸ¤– Validar Topologia IA

on:
  push:
    branches: [main, develop, staging]
  pull_request:
    branches: [main, develop]

jobs:
  validate-ia-topology:
    name: ValidaÃ§Ã£o de Topologia IA
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "pnpm"

      - name: ğŸ“¦ Instalar pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: ğŸ“š Instalar dependÃªncias
        run: pnpm install --frozen-lockfile

      - name: ğŸ” Validar Topologia IA (ProduÃ§Ã£o)
        env:
          NODE_ENV: production
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          SUPABASE_FUNCTIONS_URL: ${{ secrets.SUPABASE_FUNCTIONS_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
        run: |
          echo "ğŸ” Validando topologia de IA para produÃ§Ã£o..."
          node tools/ia/ia-validator.js

      - name: ğŸ“Š Verificar Edge Functions
        run: |
          echo "ğŸ“Š Auditando Edge Functions..."
          node tools/ia/check-edge-functions.js

      - name: ğŸ“„ Upload RelatÃ³rio de ValidaÃ§Ã£o
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: ia-validation-report
          path: .cursor/agents/ia-validator/*.json
          retention-days: 30

      - name: ğŸ’¬ Comentar PR com Resultado
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            // Ler Ãºltimo relatÃ³rio
            const reportsDir = '.cursor/agents/ia-validator';
            const files = fs.readdirSync(reportsDir)
              .filter(f => f.startsWith('topology-validation'))
              .sort()
              .reverse();

            if (files.length > 0) {
              const reportPath = path.join(reportsDir, files[0]);
              const report = JSON.parse(fs.readFileSync(reportPath, 'utf8'));
              
              const status = report.status === 'PASS' ? 'âœ…' : 'âŒ';
              const emoji = report.violations === 0 ? 'ğŸ‰' : 'ğŸš¨';
              
              let comment = `${emoji} **ValidaÃ§Ã£o de Topologia IA**\n\n`;
              comment += `**Status:** ${status} ${report.status}\n`;
              comment += `**Ambiente:** ${report.mode}\n`;
              comment += `**ViolaÃ§Ãµes:** ${report.violations}\n`;
              comment += `**Avisos:** ${report.warnings}\n\n`;
              
              if (report.violations > 0) {
                comment += `### ğŸš¨ ViolaÃ§Ãµes Detectadas\n\n`;
                report.details.violations.forEach((v, i) => {
                  comment += `${i + 1}. **${v.file}**\n`;
                  comment += `   - ${v.issue}\n`;
                  comment += `   - AÃ§Ã£o: ${v.action}\n\n`;
                });
                comment += `\nâš ï¸ **Deploy bloqueado atÃ© correÃ§Ã£o das violaÃ§Ãµes!**\n`;
              } else {
                comment += `### âœ… Topologia VÃ¡lida\n\n`;
                comment += `Zero violaÃ§Ãµes detectadas. Deploy aprovado!\n`;
              }
              
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }

      - name: âŒ Falhar se ViolaÃ§Ãµes
        if: failure()
        run: |
          echo "âŒ ValidaÃ§Ã£o falhou! Corrija as violaÃ§Ãµes antes de fazer merge."
          exit 1

  lint:
    name: Linter e Type Check
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "pnpm"

      - uses: pnpm/action-setup@v2
        with:
          version: 8

      - run: pnpm install --frozen-lockfile

      - name: ğŸ” ESLint
        run: pnpm lint

      - name: ğŸ”§ TypeScript Check
        run: pnpm type-check || tsc --noEmit

  test-agents:
    name: Testar Agentes
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "pnpm"

      - uses: pnpm/action-setup@v2
        with:
          version: 8

      - run: pnpm install --frozen-lockfile

      - name: ğŸ§ª Testar Comandos de Agentes
        run: |
          echo "ğŸ§ª Testando comandos de agentes..."

          # Teste 1: IA-Validator
          echo "Test 1: IA-Validator"
          NODE_ENV=development node tools/ia/ia-validator.js || true

          # Teste 2: Contador
          echo "Test 2: Contador"
          node tools/compliance/fiscal/check-erp-fiscal.js

          # Teste 3: Tutor
          echo "Test 3: Tutor"
          node tools/tutor/classificar-gaps.js

          echo "âœ… Todos os testes de agentes passaram!"

  build:
    name: Build de ProduÃ§Ã£o
    runs-on: ubuntu-latest
    needs: [validate-ia-topology, lint]

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "pnpm"

      - uses: pnpm/action-setup@v2
        with:
          version: 8

      - run: pnpm install --frozen-lockfile

      - name: ğŸ—ï¸ Build
        env:
          NODE_ENV: production
        run: pnpm build

      - name: ğŸ“Š Analisar Bundle
        run: |
          echo "ğŸ“Š AnÃ¡lise de bundle size..."
          du -sh .next/ || echo "Next.js build"

  security-audit:
    name: Auditoria de SeguranÃ§a
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: ğŸ”’ npm audit
        run: npm audit --audit-level=moderate || true

      - name: ğŸ” Verificar dependÃªncias
        run: npm outdated || true
