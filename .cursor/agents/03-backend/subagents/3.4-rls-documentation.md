# Subagente 3.4: RLS Policies Documentation

## ‚ö†Ô∏è IMPORTANTE

Este subagente **DOCUMENTA** as RLS policies necess√°rias, mas **N√ÉO AS IMPLEMENTA**.

A implementa√ß√£o ser√° feita manualmente ap√≥s revis√£o do time de seguran√ßa.

---

## üîê Padr√£o Multi-Tenant

Todas as tabelas com `empresa_id` devem ter policies que garantem:

```sql
-- Usu√°rios s√≥ veem dados da pr√≥pria empresa
CREATE POLICY "users_see_own_company"
ON [tabela]
FOR SELECT
USING (empresa_id = current_empresa_id());

-- Usu√°rios s√≥ inserem dados na pr√≥pria empresa
CREATE POLICY "users_insert_own_company"
ON [tabela]
FOR INSERT
WITH CHECK (empresa_id = current_empresa_id());

-- Usu√°rios s√≥ atualizam dados da pr√≥pria empresa
CREATE POLICY "users_update_own_company"
ON [tabela]
FOR UPDATE
USING (empresa_id = current_empresa_id());

-- Usu√°rios s√≥ deletam dados da pr√≥pria empresa
CREATE POLICY "users_delete_own_company"
ON [tabela]
FOR DELETE
USING (empresa_id = current_empresa_id());
```

---

## üìã Tabelas que PRECISAM de RLS

### Core (2 tabelas)

#### 1. `profiles`

```sql
-- Usu√°rios veem apenas seu pr√≥prio perfil
CREATE POLICY "users_see_own_profile"
ON profiles FOR SELECT
USING (id = auth.uid());

-- Usu√°rios atualizam apenas seu pr√≥prio perfil
CREATE POLICY "users_update_own_profile"
ON profiles FOR UPDATE
USING (id = auth.uid());
```

**Status:** üìù Documentado  
**Prioridade:** üî¥ Cr√≠tica  
**Implementar:** Fase de Deploy  

---

#### 2. `empresas`

```sql
-- Usu√°rios veem apenas sua empresa
CREATE POLICY "users_see_own_empresa"
ON empresas FOR SELECT
USING (id = current_empresa_id());

-- Apenas admins atualizam empresa
CREATE POLICY "admins_update_empresa"
ON empresas FOR UPDATE
USING (
  id = current_empresa_id() AND
  current_user_role() IN ('Super Admin', 'Admin')
);
```

**Status:** üìù Documentado  
**Prioridade:** üî¥ Cr√≠tica  

---

### OPME Business (6 tabelas)

#### 3. `cirurgias` (25 colunas)

```sql
-- Multi-tenant SELECT
CREATE POLICY "users_see_own_company_cirurgias"
ON cirurgias FOR SELECT
USING (empresa_id = current_empresa_id());

-- INSERT com valida√ß√£o de role
CREATE POLICY "authorized_insert_cirurgias"
ON cirurgias FOR INSERT
WITH CHECK (
  empresa_id = current_empresa_id() AND
  current_user_role() IN ('Admin', 'Gerente', 'Coordenador')
);

-- UPDATE com valida√ß√£o de status
CREATE POLICY "authorized_update_cirurgias"
ON cirurgias FOR UPDATE
USING (
  empresa_id = current_empresa_id() AND
  (
    current_user_role() IN ('Admin', 'Gerente') OR
    (current_user_role() = 'Coordenador' AND status != 'FINALIZADA')
  )
);

-- DELETE apenas para Admins
CREATE POLICY "admin_delete_cirurgias"
ON cirurgias FOR DELETE
USING (
  empresa_id = current_empresa_id() AND
  current_user_role() = 'Admin'
);
```

**Status:** üìù Documentado  
**Prioridade:** üî¥ Cr√≠tica  
**Notas:** Validar regras de status com time de produto

---

#### 4. `estoque`

```sql
-- Padr√£o multi-tenant
-- SELECT: Multi-tenant
-- INSERT/UPDATE: Apenas Gerente ou Admin
-- DELETE: Apenas Admin

CREATE POLICY "estoque_select"
ON estoque FOR SELECT
USING (empresa_id = current_empresa_id());

CREATE POLICY "estoque_modify"
ON estoque FOR INSERT, UPDATE
WITH CHECK (
  empresa_id = current_empresa_id() AND
  current_user_role() IN ('Admin', 'Gerente')
);

CREATE POLICY "estoque_delete"
ON estoque FOR DELETE
USING (
  empresa_id = current_empresa_id() AND
  current_user_role() = 'Admin'
);
```

**Status:** üìù Documentado  
**Prioridade:** üî¥ Cr√≠tica  

---

#### 5. `consignacao_materiais`

```sql
-- Padr√£o multi-tenant com valida√ß√µes especiais
-- UPDATE de status permitido para Operadores

CREATE POLICY "consignacao_select"
ON consignacao_materiais FOR SELECT
USING (empresa_id = current_empresa_id());

CREATE POLICY "consignacao_insert"
ON consignacao_materiais FOR INSERT
WITH CHECK (
  empresa_id = current_empresa_id() AND
  current_user_role() IN ('Admin', 'Gerente', 'Coordenador')
);

CREATE POLICY "consignacao_update"
ON consignacao_materiais FOR UPDATE
USING (
  empresa_id = current_empresa_id() AND
  (
    current_user_role() IN ('Admin', 'Gerente') OR
    (current_user_role() = 'Operador' AND old.status = 'PENDENTE')
  )
);

CREATE POLICY "consignacao_delete"
ON consignacao_materiais FOR DELETE
USING (
  empresa_id = current_empresa_id() AND
  current_user_role() = 'Admin'
);
```

**Status:** üìù Documentado  
**Prioridade:** üî¥ Cr√≠tica  

---

#### 6-8. `produtos_opme`, `rastreabilidade_opme`, `compliance_requisitos_abbott`

```sql
-- Aplicar padr√£o multi-tenant b√°sico:
-- SELECT: Multi-tenant
-- INSERT/UPDATE/DELETE: Gerente ou Admin

CREATE POLICY "[tabela]_select"
ON [tabela] FOR SELECT
USING (empresa_id = current_empresa_id());

CREATE POLICY "[tabela]_modify"
ON [tabela] FOR INSERT, UPDATE, DELETE
USING (
  empresa_id = current_empresa_id() AND
  current_user_role() IN ('Admin', 'Gerente')
);
```

**Status:** üìù Documentado  
**Prioridade:** üî¥ Cr√≠tica  

---

### Financial (3 tabelas)

#### 9-11. `contas_receber`, `contas_pagar`, `fluxo_caixa`

```sql
-- SELECT: Multi-tenant
-- INSERT/UPDATE: Apenas Gerente Financeiro ou Admin
-- DELETE: Apenas Admin

CREATE POLICY "financial_select"
ON [tabela] FOR SELECT
USING (empresa_id = current_empresa_id());

CREATE POLICY "financial_modify"
ON [tabela] FOR INSERT, UPDATE
WITH CHECK (
  empresa_id = current_empresa_id() AND
  current_user_role() IN ('Admin', 'Gerente Financeiro')
);

CREATE POLICY "financial_delete"
ON [tabela] FOR DELETE
USING (
  empresa_id = current_empresa_id() AND
  current_user_role() = 'Admin'
);
```

**Status:** üìù Documentado  
**Prioridade:** üî¥ Cr√≠tica  

---

### Logistics (2 tabelas)

#### 12-13. `transportadoras`, `rastreamento_entregas`

```sql
-- Padr√£o multi-tenant
-- UPDATE de status permitido para Operadores

CREATE POLICY "logistics_select"
ON [tabela] FOR SELECT
USING (empresa_id = current_empresa_id());

CREATE POLICY "logistics_insert"
ON [tabela] FOR INSERT
WITH CHECK (
  empresa_id = current_empresa_id() AND
  current_user_role() IN ('Admin', 'Gerente', 'Coordenador')
);

CREATE POLICY "logistics_update"
ON [tabela] FOR UPDATE
USING (
  empresa_id = current_empresa_id() AND
  current_user_role() IN ('Admin', 'Gerente', 'Operador')
);

CREATE POLICY "logistics_delete"
ON [tabela] FOR DELETE
USING (
  empresa_id = current_empresa_id() AND
  current_user_role() = 'Admin'
);
```

**Status:** üìù Documentado  
**Prioridade:** üü° Importante  

---

## üõ†Ô∏è Fun√ß√µes Auxiliares Necess√°rias

### current_empresa_id()

```sql
CREATE OR REPLACE FUNCTION current_empresa_id()
RETURNS UUID AS $$
BEGIN
  RETURN (
    SELECT empresa_id 
    FROM profiles 
    WHERE id = auth.uid()
  );
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

**Status:** üìù Documentado  
**Prioridade:** üî¥ Cr√≠tica (prerequisito)  

---

### current_user_role()

```sql
CREATE OR REPLACE FUNCTION current_user_role()
RETURNS TEXT AS $$
BEGIN
  RETURN (
    SELECT role 
    FROM profiles 
    WHERE id = auth.uid()
  );
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

**Status:** üìù Documentado  
**Prioridade:** üî¥ Cr√≠tica (prerequisito)  

---

## üìä Resumo

### Tabelas Documentadas

- ‚úÖ Core: 2 tabelas
- ‚úÖ OPME: 6 tabelas
- ‚úÖ Financial: 3 tabelas
- ‚úÖ Logistics: 2 tabelas
- **Total:** 13 tabelas cr√≠ticas

### Fun√ß√µes Auxiliares

- ‚úÖ current_empresa_id()
- ‚úÖ current_user_role()

### Prioridades

- üî¥ **Cr√≠ticas:** 11 policies
- üü° **Importantes:** 2 policies

---

## üìù Pr√≥ximos Passos

1. **Revisar** documenta√ß√£o com time de seguran√ßa
2. **Validar** regras de neg√≥cio com product owner
3. **Implementar** policies em ambiente de staging
4. **Testar** com diferentes roles
5. **Deploy** para produ√ß√£o

---

## ‚ö†Ô∏è Avisos Importantes

- **N√ÉO implementar** sem revis√£o de seguran√ßa
- **Testar exaustivamente** em staging antes de produ√ß√£o
- **Considerar performance** - RLS adiciona overhead
- **Monitorar** queries lentas ap√≥s implementa√ß√£o

---

**Documentado por:** Agente 03 - Subagente 3.4  
**Data:** 2025-10-25  
**Status:** ‚úÖ Documenta√ß√£o completa  
**Implementa√ß√£o:** ‚è≥ Pendente revis√£o
